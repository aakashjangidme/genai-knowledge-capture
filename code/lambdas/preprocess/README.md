# Preprocess Lambda

## Introduction

This AWS Lambda preprocess users input and generate a list of URIs containing audio files.

## Component Details

#### Prerequisites

- [Python 3.12](https://www.python.org/downloads/release/python-3120/) or later
- [AWS Lambda Powertools 2.35.1](https://docs.powertools.aws.dev/lambda/python/2.35.1/)

#### Technology stack

- [AWS Lambda](https://aws.amazon.com/lambda/)
- [Amazon S3](https://aws.amazon.com/s3/)

#### Package Details

| Files                            | Description                                                                                                    |
| -------------------------------- | -------------------------------------------------------------------------------------------------------------- |
| [connections.py](connections.py) | Python file with `Connections` class for establishing connections with external dependencies of the lambda     |
| [exceptions.py](exceptions.py)   | Python file containing custom exception classes `CodeError` and `ConnectionError`                              |
| [preprocess.py](preprocess.py)   | Python file containing the `lambda_handler` function that acts as the starting point for AWS Lambda invocation |
| [s3url.py](s3url.py)             | Python file containing util function to parse s3 url                                                           |

#### Input

The AWS Lambda is part of a AWS Step Function and it requires following string as input. The input for the lambda is received from user who starts the Step Function execution.

```json
{
  "documentName": str,
  "audioFileFolderUri": str
}

```

| Field                | Description                                                 | Data Type |
| -------------------- | ----------------------------------------------------------- | --------- |
| `documentName`       | User input document name.                                   | String    |
| `audioFileFolderUri` | The s3 uri indicating where a set of audio files are stored | String    |

#### Output

The AWS Lambda is part of a AWS Step Function and it generates the following JSON as output.

```json
{
  "statusCode": int,
  "documentName": str,
  "audioFilesS3Uris": List[str],
  "serviceName": 'app-preprocess'
}
```

| Field              | Description                                                                                                            | Data Type      |
| ------------------ | ---------------------------------------------------------------------------------------------------------------------- | -------------- |
| `statusCode`       | A HTTP status code that denotes the output status of validation. A `200` value means validation completed successfully | Number         |
| `documentName`     | User input document name                                                                                               | String         |
| `audioFilesS3Uris` | The s3 uris of texts generated by transcribe                                                                           | List of String |
| `serviceName`      | The name of the AWS Lambda as configured through AWS Powertools across log statements                                  | String         |

#### Environmental Variables

| Field                          | Description                                                     | Data Type |
| ------------------------------ | --------------------------------------------------------------- | --------- |
| `POWERTOOLS_LOG_LEVEL`         | Sets how verbose Logger should be (INFO, by default)            | String    |
| `DATA_SOURCE_BUCKET_NAME`      | S3 bucket where audio files are stored                          | String    |
| `POWERTOOLS_SERVICE_NAME`      | Sets service key that will be present across all log statements | String    |
| `POWERTOOLS_METRICS_NAMESPACE` | Sets namespace key that will be present across metrics log      | String    |
| `AWS_REGION`                   | AWS Region where the solution is deployed                       | String    |
